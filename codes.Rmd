---
title: "My R Codes For Data Analysis"
subtitle: "In this repository I am going to collect `R codes` for data analysis."
author: "[Serdar Balcı, MD, Pathologist](https://www.serdarbalci.com/)"
date: '`r format(Sys.Date())`'
output: 
  html_notebook: 
    fig_caption: yes
    highlight: tango
    number_sections: yes
    theme: paper
    toc: yes
    toc_float: yes
  html_document: 
    code_folding: hide
    df_print: kable
    keep_md: yes
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float: yes
    highlight: kate
---

# Getting Data into R

Load required packages
```{r load required packages 1, message=FALSE, warning=FALSE}
library(tidyverse)
```

## Import using RStudio


## Import Excel File


## Import SPSS File

## Prepare Data for Analysis

### SPSS labels

```{r}
library(foreign) # foreign paketi yükleniyor
```

read.spss komutu ile değer etiketlerini almasını ve bunu liste olarak değil de data.frame olarak kaydetmesini istiyoruz

```{r}
mydata <- read.spss("mydata.sav", use.value.labels = TRUE, to.data.frame = TRUE)
```

aktardığımız data.frame'in özellikleri (attr) içinde değişkenlerin etiketleri var, bunları dışarı çıkartıyoruz

```{r}
VariableLabels <- as.data.frame(attr(mydata, "variable.labels"))
```


elde ettiğimiz data.frame'deki satır isimleri değişkenlerin isimleri oluyor, karşılarında da değişken etiketleri var
satır isimlerini de dışarı çıkartıyoruz

```{r}
VariableLabels$original <- rownames(VariableLabels)
```

Değişken etiketi olanları etiketleri ile diğerlerini olduğu gibi saklıyoruz  

```{r}
VariableLabels$label[VariableLabels$label ==""] <- NA 
VariableLabels$colname <- VariableLabels$original
VariableLabels$colname[!is.na(VariableLabels$label)] <- as.vector(VariableLabels$label[!is.na(VariableLabels$label)])
```

son olarak da data.frame'deki sütun isimlerini değiştiriyoruz

```{r}
names(mydata) <- VariableLabels$colname
```


# make names

turkce karakter donusumu

```{r turkce karakter donusumu}
# https://suatatan.wordpress.com/2017/10/07/bulk-replacing-turkish-characters-in-r/
to.plain <- function(s) {
        # 1 character substitutions
    old1 <- "çğşıüöÇĞŞİÖÜ"
    new1 <- "cgsiuocgsiou"
    s1 <- chartr(old1, new1, s)
    # 2 character substitutions
    old2 <- c("œ", "ß", "æ", "ø")
    new2 <- c("oe", "ss", "ae", "oe")
    s2 <- s1
    for(i in seq_along(old2)) s2 <- gsub(old2[i], new2[i], s2, fixed = TRUE)
    s2
}


df$source=as.vector(sapply(df$source,to.plain))

makeNames(tolower(names(df)))
to.plain(names(df))

purrr::map(df, to.plain)

```


#### veriye ID ekleme

```{r}
df <- tibble::rowid_to_column(df, "subject")
```




# gerekli paketi yükleme
library(tidyverse)
library(haven)
# dosyayı yükleme
EDT256 <- read_sav("EDT256.sav")



# gerekli sütunları seçme
EDT256 <- EDT256 %>%
    select(subject, tanı, starts_with("beck"))

# değişken değerlerini yeniden atama
EDT256$tanı <- as_factor(EDT256$tanı, labels = "values")

# yatay veriyi uzun hale getirme
EDT256_new <- EDT256 %>%
    gather(- c("subject","tanı"), key = zaman, value = beck_int_score)


# değişkenleri rakamsal hale getirme
EDT256_new$zaman[which(EDT256_new$zaman == "beck_int_P")] <- 0
EDT256_new$zaman[which(EDT256_new$zaman == "beck_int_A1")] <- 1
EDT256_new$zaman[which(EDT256_new$zaman == "beck_int_A2")] <- 2

# değişken değerlerini atama 
EDT256_new$zaman <- factor(EDT256_new$zaman, levels = c(0,1,2),
                           labels = c("Tedavi Öncesi", "T. Sonrası 1. Hafta",
                                      "T. Sonrası 2. Hafta"))


# nparLD analizi

# gerekli paketi yükleme
library(nparLD)

# model oluşturma
modelEDT256 <- nparLD(beck_int_score ~ tanı * zaman, data = EDT256_new,
                      subject = "subject",
                      plot.CI = TRUE, show.covariance = TRUE)

# model sonucunu yazdır
out <- capture.output(modelEDT256)
cat("EDT256 Model", out, file = "EDT256.txt", sep = "\n", append=TRUE)

# model grafiği
plot(modelEDT256)

# plot sonucunu yazdır
out2 <- capture.output(plot(modelEDT256))
cat("\n","EDT256 Plot", out2, file = "EDT256.txt", sep = "\n", append = TRUE)

# grafiği yazdır
jpeg('modelEDT256.jpeg')
plot(modelEDT256)
dev.off()

# model özeti
summary(modelEDT256)

# model özeti sonucunu yazdır
out3 <- capture.output(modelEDT256)
cat("\n","EDT256 summary", out3, file = "EDT256.txt", sep = "\n", append=TRUE)


# ek olarak boxplot oluşturma
boxplot(beck_int_score ~ tanı * zaman, data = EDT256_new,
        names = FALSE,col = c("grey",2),lwd = 2)
axis(1,at = 1.5,labels = "Tedavi Öncesi",font = 2,cex = 3)
axis(1,at = 3.5,labels = "T. Sonrası 1. Hafta",font = 2,cex = 3)
axis(1,at = 5.5,labels = "T. Sonrası 2. Hafta",font = 2,cex = 3)
legend(5,35,c("Tanı 1","Tanı 2"),
       lwd = c(2,2),
       col = c("grey",2),cex = 0.7)

# boxplot yazdır
jpeg('boxplotEDT256.jpeg')
boxplot(beck_int_score ~ tanı * zaman, data = EDT256_new,
        names = FALSE,col = c("grey",2),lwd = 2)
axis(1,at = 1.5,labels = "Tedavi Öncesi",font = 2,cex = 3)
axis(1,at = 3.5,labels = "T. Sonrası 1. Hafta",font = 2,cex = 3)
axis(1,at = 5.5,labels = "T. Sonrası 2. Hafta",font = 2,cex = 3)
legend(5,35,c("Tanı 1","Tanı 2"),
       lwd = c(2,2),
       col = c("grey",2),cex = 0.7)
dev.off()










# Analysis

## Survival Analysis

https://github.com/datacamp/tutorial

Based on https://www.datacamp.com/community/tutorials/survival-analysis-R


```{r}
library(tutorial)
library(survival)
library(survminer)
library(tidyverse)
library(jmv)
```


```{r}
data(ovarian)
glimpse(ovarian)
help(ovarian)
```


```{r}
summary(ovarian)
```


```{r}
varOvarian <- names(ovarian)

ovarian2 <- ovarian %>% 
    map_df(as.factor)

jmv::descriptives(ovarian, varOvarian, freq = TRUE)

jmv::descriptives(ovarian2, varOvarian, freq = TRUE)

```


```{r}
# Dichotomize age and change data labels
ovarian$rx <- factor(ovarian$rx, 
                     levels = c("1", "2"), 
                     labels = c("A", "B"))
ovarian$resid.ds <- factor(ovarian$resid.ds, 
                           levels = c("1", "2"), 
                           labels = c("no", "yes"))
ovarian$ecog.ps <- factor(ovarian$ecog.ps, 
                          levels = c("1", "2"), 
                          labels = c("good", "bad"))

jmv::descriptives(ovarian, varOvarian, freq = TRUE)

```


```{r}
# Data seems to be bimodal
hist(ovarian$age)
```


```{r}
ovarian <- ovarian %>% mutate(age_group = ifelse(age >= 50, "old", "young"))
ovarian$age_group <- factor(ovarian$age_group)

varOvarian <- names(ovarian)

jmv::descriptives(ovarian, varOvarian, freq = TRUE)
```


```{r}
# Fit survival data using the Kaplan-Meier method
surv_object <- Surv(time = ovarian$futime, event = ovarian$fustat)
surv_object
```

```{r}
fit1 <- survfit(surv_object ~ rx, data = ovarian)
summary(fit1)
```


```{r}
ggsurvplot(fit1, data = ovarian, pval = TRUE)
```


```{r}
# Examine prdictive value of residual disease status
fit2 <- survfit(surv_object ~ resid.ds, data = ovarian)
ggsurvplot(fit2, data = ovarian, pval = TRUE)
```

```{r}
# Fit a Cox proportional hazards model
fit.coxph <- coxph(surv_object ~ rx + resid.ds + age_group + ecog.ps, 
                   data = ovarian)
ggforest(fit.coxph, data = ovarian) +
    geom_errorbar(na.rm = TRUE)
```






# Survival Analysis in R

https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/?mkt_tok=eyJpIjoiWm1Zd1pqRmlaVGc0WXpGaiIsInQiOiIwalwvV2VRWmtwTUY4alFxR3pqaWp0MzdheHRXTlBabHRlaTlcL28xUE1iWFV4M0dLT0hkUjFycVphYXRBeEJsQ2tXNXA3eEVTam5FdUVOaHRkYkpZdWg3eDR4eTQ4M2FFNE05cDFQV3A4UUFBaGxuRkZBSVRlTmRBTDlERFhxZWh2In0%3D

library(survival)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)

data(veteran)
head(veteran)

km <- with(veteran, Surv(time, status))

head(km,80)


km_fit <- survfit(Surv(time, status) ~ 1, data = veteran)

km_fit

summary(km_fit, times = c(1,30,60,90*(1:10)))

plot(km_fit, xlab="Days", main = 'Kaplan Meyer Plot') #base graphics is always ready
autoplot(km_fit)

km_trt_fit <- survfit(Surv(time, status) ~ trt, data = veteran)
km_trt_fit

autoplot(km_trt_fit)


vet <- mutate(veteran, AG = ifelse((age < 60), "LT60", "OV60"),
              AG = factor(AG),
              trt = factor(trt,labels=c("standard","test")),
              prior = factor(prior,labels=c("N0","Yes")))

km_AG_fit <- survfit(Surv(time, status) ~ AG, data = vet)
km_AG_fit

autoplot(km_AG_fit)


Fit Cox Model
cox <- coxph(Surv(time, status) ~ trt + celltype + karno + diagtime + age + prior , data = vet)
cox
summary(cox)

cox_fit <- survfit(cox)
cox_fit
plot(cox_fit, main = "cph model", xlab="Days")
autoplot(cox_fit)

aa_fit <-aareg(Surv(time, status) ~ trt + celltype +
                   karno + diagtime + age + prior , 
               data = vet)
aa_fit


#summary(aa_fit)  # provides a more complete summary of results
autoplot(aa_fit)


# ranger model
r_fit <- ranger(Surv(time, status) ~ trt + celltype + 
                    karno + diagtime + age + prior,
                data = vet,
                mtry = 4,
                importance = "permutation",
                splitrule = "extratrees",
                verbose = TRUE)


# Average the survival models
death_times <- r_fit$unique.death.times 
surv_prob <- data.frame(r_fit$survival)
avg_prob <- sapply(surv_prob,mean)

# Plot the survival models for each patient
plot(r_fit$unique.death.times,r_fit$survival[1,], 
     type = "l", 
     ylim = c(0,1),
     col = "red",
     xlab = "Days",
     ylab = "survival",
     main = "Patient Survival Curves")

#
cols <- colors()
for (n in sample(c(2:dim(vet)[1]), 20)){
    lines(r_fit$unique.death.times, r_fit$survival[n,], type = "l", col = cols[n])
}
lines(death_times, avg_prob, lwd = 2)
legend(500, 0.7, legend = c('Average = black'))


vi <- data.frame(sort(round(r_fit$variable.importance, 4), decreasing = TRUE))
names(vi) <- "importance"
head(vi)


cat("Prediction Error = 1 - Harrell's c-index = ", r_fit$prediction.error)


# Set up for ggplot
kmi <- rep("KM",length(km_fit$time))
km_df <- data.frame(km_fit$time,km_fit$surv,kmi)
names(km_df) <- c("Time","Surv","Model")

coxi <- rep("Cox",length(cox_fit$time))
cox_df <- data.frame(cox_fit$time,cox_fit$surv,coxi)
names(cox_df) <- c("Time","Surv","Model")

rfi <- rep("RF",length(r_fit$unique.death.times))
rf_df <- data.frame(r_fit$unique.death.times,avg_prob,rfi)
names(rf_df) <- c("Time","Surv","Model")

plot_df <- rbind(km_df,cox_df,rf_df)

p <- ggplot(plot_df, aes(x = Time, y = Surv, color = Model))
p + geom_line()




############





install.packages("OIsurv")
library(OIsurv)

library(help=KMsurv)

data(aids)
glimpse(aids)


data(tongue)

glimpse(tongue)

my.surv.object <- Surv(tongue$time[tongue$type==1], tongue$delta[tongue$type==1])

my.surv.object

data(psych)

my.surv.object2 <- Surv(psych$age, psych$age+psych$time, psych$death)

my.surv.object2



```{r}
library("survival")
fit <- survfit(Surv(time,status)
~ sex, data = lung)
class(fit)
## [1] "survfit"
library("survminer")
ggsurvplot(fit, data = lung)
```


```{r}
ggsurvplot(fit, data = lung, fun = "event")

```


```{r}
ggsurvplot(fit, data = lung, fun = "cumhaz")
```

```{r}
ggsurvplot(fit, data = lung,
conf.int = TRUE,
pval = TRUE,
fun = "pct",
risk.table = TRUE,
tables.height = 0.3,
size = 0.8,
linetype = "strata",
palette = c("#E7B800",
"#2E9FDF"),
legend = "top",
legend.title = "Sex",
legend.labs = c("Male",
"Female"),
cex = 0.2
)
```

```{r}
library("survival")
fit <- coxph(Surv(time, status) ~ sex + age, data = lung)
ftest <- cox.zph(fit)
ftest
```

```{r}
library("survminer")
ggcoxzph(ftest)
```


```{r}
library("survival")
library("survminer")
fit <- coxph(Surv(time, status) ~
sex + age, data = lung)

```




```{r}
ggcoxdiagnostics(fit,
type = "deviance",
ox.scale = "linear.predictions")

```



```{r}
ggcoxdiagnostics(fit,
type = "schoenfeld",
ox.scale = "time")
```


















# Packages

## tangram

https://github.com/spgarbet/tangram
http://htmlpreview.github.io/?https://github.com/spgarbet/tg/blob/master/vignettes/example.html

library(tangram)
library(Hmisc)
getHdata(pbc)
View(pbc)
table <- tangram(drug ~ bili + albumin + stage + protime + sex + age + spiders, data = pbc)

table
html5(table)
latex(table)
index(table)

write(
html5(tangram("drug ~ bili[2] + albumin + stage::Categorical + protime + sex + age + spiders", pbc, msd=TRUE, quant=seq(0, 1, 0.25)),
      fragment=TRUE, inline="hmisc.css", caption = "HTML5 Table Hmisc Style", id="tbl2"),
"tangram1.html")

write(
html5(tangram("drug ~ bili[2] + albumin + stage::Categorical + protime + sex + age + spiders", pbc),
      fragment=TRUE, inline="nejm.css", caption = "HTML5 Table NEJM Style", id="tbl3"),
"tangram_nejm.html")


tbl <- tangram("drug ~ bili[2] + albumin + stage::Categorical[1] + protime + sex[1] + age + spiders[1]", 
               data=pbc,
               pformat = 5)
write(html5(tbl,
      fragment=TRUE,
      inline="lancet.css",
      caption = "HTML5 Table Lancet Style", id="tbl4"
),
"tangram_lancet.html")

index(tangram("drug ~ bili + albumin + stage::Categorical + protime + sex + age + spiders", pbc))[1:20,]


library(readxl)
MDL307_Data <- read_excel("MDL307 - Data.xlsx")

MDL307_Data <- as.data.frame(MDL307_Data)

names(MDL307_Data)

View(MDL307_Data)

MDL307_Data$biyokimyasalrekurrens <- as.factor(MDL307_Data$biyokimyasalrekurrens)
levels(MDL307_Data$biyokimyasalrekurrens)[1] <- "yok"
levels(MDL307_Data$biyokimyasalrekurrens)[2] <- "var"

collist <- c("gleasonskor",
                 "tersiyer",
                 "kribriform",
                 "cerrahisinir",
                 "ekstaprostatik",
                 "lenfnodu",
                 "seminalvezikul"
                 )


MDL307_Data[collist] <- lapply(MDL307_Data[collist], as.factor)


table <- tangram(biyokimyasalrekurrens ~ yas +
                 gleasonskor +
                 tersiyer +
                 kribriform +
                 kribriformyuzde +
                 cerrahisinir +
                 ekstaprostatik +
                 lenfnodu +
                 seminalvezikul +
                 biyokimyasalrekurrens,
                 data = MDL307_Data)
table





# sheets

library(tidyverse)
library(readxl)


path <- "ICPN_RAW.xls"
sheetlist <- path %>% 
    excel_sheets() %>% 
    set_names() %>% 
    map(read_excel, skip = 1, path = path)

sheetlist <- sheetlist[-29]


sheetlist <- sheetlist %>%
    reduce(left_join, by = "Respondant", .id = "id", suffix = c("1","2"))

names(sheetlist)

columnNames <- c(
    "ID",
    "DX",
    "y/n",
    "~plastic",
    "WHO- 2010 classification",
    "GRADE",
    "INVASIVE CA",
    "CELL LINEAGE",
    "IPMN Lineage (PRE/MIN)",
    "experience with this invasion",
    "COMMENTS"
)

columnNumbers <- rep(c(1:28), each = 11)

columnNames2 <- paste(columnNames, columnNumbers, sep = "")

columnNames2 <- c("Respondant", columnNames2)

names(sheetlist) <- columnNames2



# "Respondant"	"ID"	"y/n"	"WHO- 2010 classification"	"GRADE"	"INVASIVE CA"	"CELL LINEAGE"	"IPMN Lineage (PRE/MIN)"

deneme <- sheetlist %>% 
    select(starts_with("Respondant"), starts_with("GRADE"))







# deneme[deneme=="HIGH"] <- 3
# deneme[deneme=="HIGH (focal)"] <- 3
# deneme[deneme=="MODERATE"] <- 2
# deneme[deneme=="LOW"] <- 1
# 
# deneme <- as.data.frame(deneme)
# 
# row.names(deneme) <- deneme$Respondant
# 
# deneme <- deneme[-1]
# 
# deneme[is.na(deneme)] <- 1
# 
# deneme <- map_df(deneme, as.matrix)
# 
# glimpse(deneme)
# 
# heatmap(deneme)

write_csv(deneme, "deneme.csv")





file.choose()


---

# Feedback

This document will be continiously updated and the last update was on `r Sys.Date()`.

[Serdar Balcı, MD, Pathologist](https://github.com/sbalci) would like to hear your feedback: [feedback form](https://goo.gl/forms/YjGZ5DHgtPlR1RnB3)